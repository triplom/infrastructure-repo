name: CI Pipeline

on:
  push:
    branches: [main, 'feature/**']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - qa
          - prod
      component:
        description: 'Component to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - app1
          - app2
          - k8s-web-app-php
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - promote

env:
  REGISTRY: ghcr.io/triplom

jobs:
  detect-changes:
    name: Detect Changed Applications
    runs-on: ubuntu-latest
    outputs:
      app1_changed: ${{ steps.changes.outputs.app1 }}
      app2_changed: ${{ steps.changes.outputs.app2 }}
      k8s_web_app_php_changed: ${{ steps.changes.outputs.k8s-web-app-php }}
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            app1:
              - 'apps/app1/**'
            app2:
              - 'apps/app2/**'
            k8s-web-app-php:
              - 'k8s/**'
              - 'src/**'
              - 'docker/**'
              - 'composer.json'
              - 'composer.lock'
            infrastructure:
              - 'apps/*/base/**'
              - 'apps/*/overlays/**'
              - '.github/workflows/**'

      - name: Set build matrix
        id: set-matrix
        run: |
          matrix="[]"
          has_changes="false"
          
          # For manual dispatch, use the selected component
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ github.event.inputs.component }}" == "all" ]]; then
              matrix='["app1", "app2", "k8s-web-app-php"]'
            else
              matrix='["${{ github.event.inputs.component }}"]'
            fi
            has_changes="true"
          else
            # For push/PR, only build changed components
            apps=()
            if [[ "${{ steps.changes.outputs.app1 }}" == "true" ]]; then
              apps+=("app1")
            fi
            if [[ "${{ steps.changes.outputs.app2 }}" == "true" ]]; then
              apps+=("app2")
            fi
            if [[ "${{ steps.changes.outputs.k8s-web-app-php }}" == "true" ]]; then
              apps+=("k8s-web-app-php")
            fi
            
            if [[ ${#apps[@]} -gt 0 ]]; then
              matrix=$(printf '%s\n' "${apps[@]}" | jq -R . | jq -s .)
              has_changes="true"
            fi
          fi
          
          echo "matrix=$matrix" >> $GITHUB_OUTPUT
          echo "has_changes=$has_changes" >> $GITHUB_OUTPUT
          echo "Build matrix: $matrix"
          echo "Has changes: $has_changes"

  test:
    name: Test Applications
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false # Keep fail-fast false to see all test results
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        if: matrix.app == 'app1' || matrix.app == 'app2'
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Test app1
        if: matrix.app == 'app1'
        run: |
          cd apps/app1
          echo "üß™ Testing app1..."
          if [ -f requirements.txt ]; then
            pip install --upgrade pip
            pip install -r requirements.txt
            pip install pytest pytest-cov flake8
            
            # Lint check
            echo "Running linting..."
            # Removed '|| true' to allow flake8 to fail the step
            flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
            
            # Run tests if test files exist
            if find . -name "test_*.py" -o -name "*_test.py" | grep -q .; then
              echo "Running tests..."
              # Added --junitxml=test-results.xml to generate JUnit report
              # Removed '|| echo "..."' to allow pytest to fail the step
              pytest --cov=./ --cov-report=xml --cov-report=term-missing --junitxml=test-results.xml
            else
              echo "No test files found, creating basic test..."
              # Create a basic test to verify the app starts
              cat > test_app.py << 'EOF'
              import pytest
              from app import app

              @pytest.fixture
              def client():
                  app.config['TESTING'] = True
                  with app.test_client() as client:
                      yield client

              def test_health_endpoint(client):
                  """Test health endpoint"""
                  rv = client.get('/health')
                  assert rv.status_code == 200
                  
              def test_root_endpoint(client):
                  """Test root endpoint"""
                  rv = client.get('/')
                  assert rv.status_code == 200
              EOF
              # Removed '|| echo "..."' to allow pytest to fail the step
              pytest test_app.py --junitxml=test-results.xml
            fi
          else
            echo "No requirements.txt found for app1"
            exit 1 # Fail if no requirements.txt, as tests can't run
          fi

      - name: Test app2
        if: matrix.app == 'app2'
        run: |
          cd apps/app2
          echo "üß™ Testing app2..."
          if [ -f requirements.txt ]; then
            pip install --upgrade pip
            pip install -r requirements.txt
            pip install pytest pytest-cov flake8
            
            # Lint check
            echo "Running linting..."
            # Removed '|| true'
            flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
            
            # Run tests
            if find . -name "test_*.py" -o -name "*_test.py" | grep -q .; then
              echo "Running tests..."
              # Added --junitxml=test-results.xml
              # Removed '|| echo "..."'
              pytest --cov=./ --cov-report=xml --cov-report=term-missing --junitxml=test-results.xml
            else
              echo "No test files found, creating basic test..."
              cat > test_app.py << 'EOF'
              import pytest
              from app import app

              @pytest.fixture
              def client():
                  app.config['TESTING'] = True
                  with app.test_client() as client:
                      yield client

              def test_health_endpoint(client):
                  """Test health endpoint"""
                  rv = client.get('/health')
                  assert rv.status_code == 200
                  
              def test_api_data_endpoint(client):
                  """Test API data endpoint"""
                  rv = client.get('/api/data')
                  assert rv.status_code == 200
              EOF
              # Removed '|| echo "..."'
              pytest test_app.py --junitxml=test-results.xml
            fi
          elif [ -f package.json ]; then
            echo "Node.js project detected"
            npm install
            # Removed '|| echo "..."'
            npm test
          else
            echo "No test configuration found for app2"
            exit 1 # Fail if no test config
          fi

      - name: Test k8s-web-app-php
        if: matrix.app == 'k8s-web-app-php'
        run: |
          echo "üß™ Testing k8s-web-app-php..."
          if [ -f composer.json ]; then
            # Install PHP and required extensions
            sudo apt-get update
            sudo apt-get install -y php8.1 php8.1-cli php8.1-mbstring php8.1-xml php8.1-zip php8.1-curl unzip
            
            # Install Composer
            curl -sS https://getcomposer.org/installer | php
            sudo mv composer.phar /usr/local/bin/composer
            
            # Validate composer.json
            # Removed '|| echo "..."'
            composer validate --strict
            
            # Install dependencies
            composer install --no-dev --optimize-autoloader --no-interaction
            
            # Run security check
            # Removed '|| echo "..."'
            composer audit
            
            # Run PHPUnit tests if available
            if [ -f vendor/bin/phpunit ]; then
              echo "Running PHPUnit tests..."
              # Added --coverage-clover=coverage.xml and --log-junit=test-results.xml
              # Removed '|| echo "..."'
              vendor/bin/phpunit --coverage-clover=coverage.xml --log-junit=test-results.xml
            elif [ -f bin/phpunit ]; then
              echo "Running PHPUnit tests..."
              # Added --coverage-clover=coverage.xml and --log-junit=test-results.xml
              # Removed '|| echo "..."'
              bin/phpunit --coverage-clover=coverage.xml --log-junit=test-results.xml
            else
              echo "No PHPUnit configuration found"
              # Basic syntax check
              # Removed '|| echo "..."'
              find src -name "*.php" -exec php -l {} \;
            fi
          else
            echo "No composer.json found for k8s-web-app-php"
            exit 1 # Fail if no composer.json
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.app }}
          path: |
            **/coverage.xml
            **/test-results.xml
          retention-days: 7

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          # Conditional scan-ref: use '.' for k8s-web-app-php, else 'apps/<app_name>'
          scan-ref: ${{ matrix.app == 'k8s-web-app-php' && '.' || format('./apps/{0}', matrix.app) }}
          format: 'sarif'
          output: 'trivy-results-${{ matrix.app }}.sarif'
          # Add continue-on-error if you want the job to pass even if Trivy finds issues,
          # otherwise, it will fail if vulnerabilities are found.
          # continue-on-error: true 

      - name: Upload Trivy scan results
        if: always()
        # Updated to v3
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results-${{ matrix.app }}.sarif'

  build:
    name: Build and Push Images
    needs: [detect-changes, test, security-scan] # Ensure all quality gates pass
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.has_changes == 'true'
    permissions:
      contents: read
      packages: write
      security-events: write
    strategy:
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    outputs:
      app1_image: ${{ steps.app1-output.outputs.image }}
      app2_image: ${{ steps.app2-output.outputs.image }}
      k8s_web_app_php_image: ${{ steps.k8s-web-app-php-output.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ matrix.app }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push app1
        if: matrix.app == 'app1'
        uses: docker/build-push-action@v5
        with:
          context: ./apps/app1
          push: true
          tags: |
            ${{ env.REGISTRY }}/app1:${{ github.sha }}
            ${{ env.REGISTRY }}/app1:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Build and push app2
        if: matrix.app == 'app2'
        uses: docker/build-push-action@v5
        with:
          context: ./apps/app2
          push: true
          tags: |
            ${{ env.REGISTRY }}/app2:${{ github.sha }}
            ${{ env.REGISTRY }}/app2:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Build and push k8s-web-app-php (PHP-FPM)
        if: matrix.app == 'k8s-web-app-php'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/php-fpm/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/k8s-web-app-php/php-fpm:${{ github.sha }}
            ${{ env.REGISTRY }}/k8s-web-app-php/php-fpm:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Build and push k8s-web-app-php (Nginx)
        if: matrix.app == 'k8s-web-app-php'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/nginx/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/k8s-web-app-php/nginx:${{ github.sha }}
            ${{ env.REGISTRY }}/k8s-web-app-php/nginx:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      # --- Image Scanning for k8s-web-app-php (two images) ---
      - name: Scan Docker image (PHP-FPM)
        if: always() && matrix.app == 'k8s-web-app-php'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/k8s-web-app-php/php-fpm:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-image-results-php-fpm.sarif'

      - name: Upload image scan results (PHP-FPM)
        if: always() && matrix.app == 'k8s-web-app-php'
        # Updated to v3
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-image-results-php-fpm.sarif'

      - name: Scan Docker image (Nginx)
        if: always() && matrix.app == 'k8s-web-app-php'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/k8s-web-app-php/nginx:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-image-results-nginx.sarif'

      - name: Upload image scan results (Nginx)
        if: always() && matrix.app == 'k8s-web-app-php'
        # Updated to v3
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-image-results-nginx.sarif'
      # --- End Image Scanning for k8s-web-app-php ---

      # --- Image Scanning for app1 and app2 (single image) ---
      - name: Scan Docker image (${{ matrix.app }})
        if: always() && (matrix.app == 'app1' || matrix.app == 'app2')
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ matrix.app }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-image-results-${{ matrix.app }}.sarif'

      - name: Upload image scan results (${{ matrix.app }})
        if: always() && (matrix.app == 'app1' || matrix.app == 'app2')
        # Updated to v3
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-image-results-${{ matrix.app }}.sarif'
      # --- End Image Scanning for app1 and app2 ---

      - name: Set app1 output
        if: matrix.app == 'app1'
        id: app1-output
        run: echo "image=${{ env.REGISTRY }}/app1:${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Set app2 output
        if: matrix.app == 'app2'
        id: app2-output
        run: echo "image=${{ env.REGISTRY }}/app2:${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Set k8s-web-app-php output
        if: matrix.app == 'k8s-web-app-php'
        id: k8s-web-app-php-output
        run: echo "image=${{ env.REGISTRY }}/k8s-web-app-php:${{ github.sha }}" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy to Environment
    # Ensure build job is successful before deploying
    needs: [detect-changes, build]
    runs-on: ubuntu-latest
    if: |
      needs.detect-changes.outputs.has_changes == 'true' && 
      (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') &&
      (github.event.inputs.action != 'promote' || github.event.inputs.action == '')
    strategy:
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    env:
      ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - name: Wait for image availability
        run: |
          echo "‚è≥ Waiting for image to be available in registry..."
          # This sleep is a workaround. A more robust solution would be a loop with `docker manifest inspect`
          # or a custom action that polls the registry.
          sleep 30
          
          # Verify image exists (this is a good check, but `docker manifest inspect` needs docker installed)
          # If this step fails due to `docker` not being available, consider removing it or installing docker.
          # For now, relying on the sleep and the downstream deployment to catch issues.
          # if ! docker manifest inspect ${{ env.REGISTRY }}/${{ matrix.app }}:${{ github.sha }} >/dev/null 2>&1; then
          #   echo "::warning::Image not immediately available, waiting longer..."
          #   sleep 60
          # fi

      - name: Trigger deployment for app1
        if: matrix.app == 'app1'
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.INFRA_REPO_PAT }}
          repository: triplom/infrastructure-repo
          event-type: app-deployment-request
          client-payload: |
            {
              "app_name": "app1",
              "repository": "${{ github.repository }}",
              "ref": "${{ github.ref }}",
              "version": "${{ github.sha }}",
              "environment": "${{ env.ENVIRONMENT }}",
              "cluster": "kind-${{ env.ENVIRONMENT }}-cluster",
              "triggered_by": "${{ github.actor }}",
              "commit_sha": "${{ github.sha }}",
              "workflow_run_id": "${{ github.run_id }}",
              "image_tag": "${{ github.sha }}"
            }

      - name: Trigger deployment for app2
        if: matrix.app == 'app2'
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.INFRA_REPO_PAT }}
          repository: triplom/infrastructure-repo
          event-type: app-deployment-request
          client-payload: |
            {
              "app_name": "app2",
              "repository": "${{ github.repository }}",
              "ref": "${{ github.ref }}",
              "version": "${{ github.sha }}",
              "environment": "${{ env.ENVIRONMENT }}",
              "cluster": "kind-${{ env.ENVIRONMENT }}-cluster",
              "triggered_by": "${{ github.actor }}",
              "commit_sha": "${{ github.sha }}",
              "workflow_run_id": "${{ github.run_id }}",
              "image_tag": "${{ github.sha }}"
            }

      - name: Trigger deployment for k8s-web-app-php
        if: matrix.app == 'k8s-web-app-php'
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.INFRA_REPO_PAT }}
          repository: triplom/infrastructure-repo
          event-type: app-deployment-request
          client-payload: |
            {
              "app_name": "k8s-web-app-php",
              "repository": "${{ github.repository }}",
              "ref": "${{ github.ref }}",
              "version": "${{ github.sha }}",
              "environment": "${{ env.ENVIRONMENT }}",
              "cluster": "kind-${{ env.ENVIRONMENT }}-cluster",
              "triggered_by": "${{ github.actor }}",
              "commit_sha": "${{ github.sha }}",
              "workflow_run_id": "${{ github.run_id }}",
              "image_tag": "${{ github.sha }}"
            }

  promote:
    name: Promote Between Environments
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.action == 'promote'
    env:
      COMPONENT: ${{ github.event.inputs.component }}
      TARGET_ENV: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout infrastructure repo
        uses: actions/checkout@v4
        with:
          repository: triplom/infrastructure-repo
          token: ${{ secrets.INFRA_REPO_PAT }}
          path: infrastructure-repo

      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Promote applications
        run: |
          cd infrastructure-repo
          
          # Determine source environment for promotion
          case "${{ env.TARGET_ENV }}" in
            "qa")
              SOURCE_ENV="dev"
              SOURCE_CLUSTER="kind-dev-cluster"
              TARGET_CLUSTER="kind-qa-cluster"
              ;;
            "prod")
              SOURCE_ENV="qa"
              SOURCE_CLUSTER="kind-qa-cluster"
              TARGET_CLUSTER="kind-prod-cluster"
              ;;
            *)
              echo "::error::Invalid promotion target. Can only promote to 'qa' or 'prod'"
              echo "::error::Promotion flow: dev ‚Üí qa ‚Üí prod"
              echo "::error::Received target environment: ${{ env.TARGET_ENV }}"
              exit 1
              ;;
          esac
          
          echo "üöÄ Promoting from $SOURCE_ENV (${SOURCE_CLUSTER}) to ${{ env.TARGET_ENV }} (${TARGET_CLUSTER})"
          
          # Function to promote a single app
          promote_app() {
            local app_name=$1
            echo "üì¶ Promoting $app_name from $SOURCE_ENV to ${{ env.TARGET_ENV }}"
            
            # Check if app exists in infrastructure repo
            if [ ! -d "apps/$app_name" ]; then
              echo "‚ö†Ô∏è  App $app_name not found in infrastructure repo, skipping"
              return 0
            fi
            
            # Check if source environment exists
            if [ ! -f "apps/$app_name/overlays/$SOURCE_ENV/kustomization.yaml" ]; then
              echo "‚ö†Ô∏è  Source environment $SOURCE_ENV not found for $app_name, skipping"
              return 0
            fi
            
            # Check if target environment exists
            if [ ! -f "apps/$app_name/overlays/${{ env.TARGET_ENV }}/kustomization.yaml" ]; then
              echo "‚ö†Ô∏è  Target environment ${{ env.TARGET_ENV }} not found for $app_name, skipping"
              return 0
            fi
            
            # Extract current image tags from source environment
            # This logic assumes a single image tag for simplicity.
            # For k8s-web-app-php, it should extract both php-fpm and nginx tags.
            # A more robust approach might involve parsing the kustomization.yaml with yq/jq.
            local source_images=""
            if [[ "$app_name" == "k8s-web-app-php" ]]; then
                source_images=$(grep -A 20 "images:" "apps/$app_name/overlays/$SOURCE_ENV/kustomization.yaml" | grep "newTag:" | sed 's/.*newTag: *//' | head -2) # Get both tags
            else
                source_images=$(grep -A 20 "images:" "apps/$app_name/overlays/$SOURCE_ENV/kustomization.yaml" | grep "newTag:" | sed 's/.*newTag: *//' | head -1) # Get single tag
            fi

            if [ -z "$source_images" ]; then
              echo "‚ö†Ô∏è  No image tags found for $app_name in $SOURCE_ENV environment"
              echo "üìã Source kustomization content:"
              cat "apps/$app_name/overlays/$SOURCE_ENV/kustomization.yaml" || echo "File not readable"
              return 0
            fi
            
            echo "üìã Found image tags in $SOURCE_ENV:"
            echo "$source_images"
            
            # Update target environment with source environment's image tags
            echo "üîÑ Updating $app_name in ${{ env.TARGET_ENV }} environment"
            cd "apps/$app_name/overlays/${{ env.TARGET_ENV }}"
            
            # Extract image names and tags from source
            # This loop needs to handle multiple tags for k8s-web-app-php correctly
            if [[ "$app_name" == "k8s-web-app-php" ]]; then
                # Assuming the order is php-fpm then nginx
                read -r php_fpm_tag <<< "$(echo "$source_images" | head -n 1)"
                read -r nginx_tag <<< "$(echo "$source_images" | tail -n 1)"

                if [ -n "$php_fpm_tag" ] && [ "$php_fpm_tag" != "latest" ]; then
                    echo "  üìù Setting php-fpm image tag: $php_fpm_tag"
                    kustomize edit set image "php-fpm=ghcr.io/triplom/k8s-web-app-php/php-fpm:$php_fpm_tag" 2>/dev/null || true
                    kustomize edit set image "ghcr.io/triplom/k8s-web-app-php/php-fpm=ghcr.io/triplom/k8s-web-app-php/php-fpm:$php_fpm_tag" 2>/dev/null || true
                fi
                if [ -n "$nginx_tag" ] && [ "$nginx_tag" != "latest" ]; then
                    echo "  üìù Setting nginx image tag: $nginx_tag"
                    kustomize edit set image "nginx=ghcr.io/triplom/k8s-web-app-php/nginx:$nginx_tag" 2>/dev/null || true
                    kustomize edit set image "ghcr.io/triplom/k8s-web-app-php/nginx=ghcr.io/triplom/k8s-web-app-php/nginx:$nginx_tag" 2>/dev/null || true
                fi
            else
                # For app1 and app2 (single tag)
                read -r tag <<< "$source_images"
                if [ -n "$tag" ] && [ "$tag" != "latest" ]; then
                    echo "  üìù Setting image tag: $tag"
                    kustomize edit set image "$app_name=ghcr.io/triplom/$app_name:$tag" 2>/dev/null || true
                    kustomize edit set image "ghcr.io/triplom/$app_name=ghcr.io/triplom/$app_name:$tag" 2>/dev/null || true
                fi
            fi
            
            cd - > /dev/null
            echo "‚úÖ Updated $app_name in ${{ env.TARGET_ENV }} environment"
            
            # Show what was updated
            echo "üìÑ Updated kustomization.yaml:"
            cat "apps/$app_name/overlays/${{ env.TARGET_ENV }}/kustomization.yaml"
          }
          
          # Promote selected component(s)
          if [[ "${{ env.COMPONENT }}" == "all" ]]; then
            echo "üîÑ Promoting all applications"
            promote_app "app1"
            promote_app "app2"
            promote_app "k8s-web-app-php"
          else
            echo "üîÑ Promoting specific component: ${{ env.COMPONENT }}"
            promote_app "${{ env.COMPONENT }}"
          fi
          
          # Show what files were changed
          echo "üìã Files changed:"
          git status --porcelain
          
          # Commit and push changes
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add .
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            git commit -m "üöÄ Promote ${{ env.COMPONENT }} from $SOURCE_ENV to ${{ env.TARGET_ENV }} (${SOURCE_CLUSTER} ‚Üí ${TARGET_CLUSTER})"
            git push
            echo "‚úÖ Promotion completed successfully"
          fi

      - name: Trigger deployment after promotion
        if: success()
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.INFRA_REPO_PAT }}
          repository: triplom/infrastructure-repo
          event-type: app-deployment-request
          client-payload: |
            {
              "app_name": "${{ env.COMPONENT }}",
              "repository": "triplom/infrastructure-repo",
              "ref": "refs/heads/main",
              "version": "promoted",
              "environment": "${{ env.TARGET_ENV }}",
              "cluster": "kind-${{ env.TARGET_ENV }}-cluster",
              "triggered_by": "${{ github.actor }}",
              "commit_sha": "promotion",
              "workflow_run_id": "${{ github.run_id }}",
              "promotion": true
            }

  notification:
    name: Send Notifications
    # Ensure all relevant jobs are listed in needs for accurate status
    needs: [detect-changes, test, security-scan, build, deploy, promote]
    runs-on: ubuntu-latest
    if: always() && needs.detect-changes.outputs.has_changes == 'true'
    steps:
      - name: Notify deployment status
        run: |
          # Determine overall status based on actual job results
          # Check for failure or cancelled status in any preceding job
          OVERALL_STATUS="success"
          if [[ "${{ needs.test.result }}" == "failure" || "${{ needs.test.result }}" == "cancelled" || \
                "${{ needs.security-scan.result }}" == "failure" || "${{ needs.security-scan.result }}" == "cancelled" || \
                "${{ needs.build.result }}" == "failure" || "${{ needs.build.result }}" == "cancelled" || \
                "${{ needs.deploy.result }}" == "failure" || "${{ needs.deploy.result }}" == "cancelled" || \
                "${{ needs.promote.result }}" == "failure" || "${{ needs.promote.result }}" == "cancelled" ]]; then
            OVERALL_STATUS="failure"
          fi
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.action }}" == "promote" ]]; then
            # Determine cluster names for promotion
            case "${{ github.event.inputs.environment }}" in
              "qa")
                SOURCE_CLUSTER="kind-dev-cluster"
                TARGET_CLUSTER="kind-qa-cluster"
                ;;
              "prod")
                SOURCE_CLUSTER="kind-qa-cluster"
                TARGET_CLUSTER="kind-prod-cluster"
                ;;
            esac
            
            echo "üöÄ Promotion workflow completed"
            echo "‚Ä¢ Component: ${{ github.event.inputs.component }}"
            echo "‚Ä¢ Source: ${SOURCE_CLUSTER}"
            echo "‚Ä¢ Target: ${TARGET_CLUSTER}"
            echo "‚Ä¢ Status: ${OVERALL_STATUS}"
            echo "‚Ä¢ Triggered by: ${{ github.actor }}"
          else
            echo "üèóÔ∏è  Build and deployment workflow completed"
            echo "‚Ä¢ Components: ${{ needs.detect-changes.outputs.matrix }}"
            echo "‚Ä¢ Environment: ${{ github.event.inputs.environment || 'dev' }}"
            echo "‚Ä¢ Cluster: kind-${{ github.event.inputs.environment || 'dev' }}-cluster"
            echo "‚Ä¢ Status: ${OVERALL_STATUS}"
            echo "‚Ä¢ Triggered by: ${{ github.actor }}"
          fi
          
          # Set step output for potential use in other integrations
          echo "status=${OVERALL_STATUS}" >> $GITHUB_OUTPUT

      - name: Create deployment summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## üöÄ CI/CD Pipeline Summary
          
          ### Components Processed
          ${{ needs.detect-changes.outputs.matrix }}
          
          ### Job Results
          | Job | Status |
          |-----|--------|
          | Detect Changes | ${{ needs.detect-changes.result }} |
          | Test | ${{ needs.test.result }} |
          | Security Scan | ${{ needs.security-scan.result }} | # Added Security Scan
          | Build | ${{ needs.build.result }} |
          | Deploy | ${{ needs.deploy.result }} |
          | Promote | ${{ needs.promote.result }} |
          
          ### Environment
          - **Target Environment**: ${{ github.event.inputs.environment || 'dev' }}
          - **Action**: ${{ github.event.inputs.action || 'deploy' }}
          - **Triggered by**: ${{ github.actor }}
          - **Commit**: ${{ github.sha }}
          EOF